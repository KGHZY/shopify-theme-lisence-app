{% comment %}
  Theme License Protection System
  Add this code to your theme's layout/theme.liquid file
  Place it right after the opening <body> tag
{% endcomment %}

{% assign license_activated = false %}
{% assign license_error = '' %}

{% comment %} Check license status via API call {% endcomment %}
<script>
  // Check license activation status
  async function checkLicenseStatus() {
    try {
      const response = await fetch('https://shopift-theme-lisence-app.vercel.app/api/license/check?license=check&domain={{ shop.permanent_domain }}');
      const data = await response.json();
      
      if (data.success && data.activated) {
        // License is activated, hide the overlay
        const overlay = document.getElementById('theme-license-notice');
        if (overlay) {
          overlay.style.display = 'none';
        }
        return true;
      }
      return false;
    } catch (error) {
      console.error('License check failed:', error);
      return false;
    }
  }

  // Check license status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkLicenseStatus();
  });
</script>

{% comment %} Default to showing overlay, will be hidden by JavaScript if license is valid {% endcomment %}
{% assign license_activated = false %}

{% comment %} Show license activation notice if not activated {% endcomment %}
{% unless license_activated %}
<div id="theme-license-notice" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 999999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
">
  <div style="
    background: white;
    padding: 40px;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  ">
    <div style="
      width: 80px;
      height: 80px;
      background: #dc3545;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 36px;
    ">
      ðŸ”’
    </div>
    
    <h2 style="
      margin: 0 0 16px 0;
      color: #333;
      font-size: 24px;
      font-weight: 600;
    ">
      Theme License Not Activated
    </h2>
    
    <p style="
      margin: 0 0 24px 0;
      color: #666;
      font-size: 16px;
      line-height: 1.5;
    ">
      This premium theme requires license activation to function properly. 
      Please activate your license to unlock all features.
    </p>
    
    <div style="
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    ">
      <h4 style="margin: 0 0 16px 0; color: #333; font-size: 16px;">
        License Activation:
      </h4>
      
      <!-- Error Message -->
      <div id="error-message" style="
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        border: 1px solid #f5c6cb;
      "></div>
      
      <!-- Success Message -->
      <div id="success-message" style="
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        border: 1px solid #c3e6cb;
      "></div>
      
      <!-- License Key Input -->
      <div style="margin-bottom: 16px;">
        <label style="
          display: block;
          font-size: 14px;
          font-weight: 500;
          color: #333;
          margin-bottom: 6px;
        ">License Key:</label>
        <input 
          type="text" 
          id="license-key-input" 
          placeholder="Enter your license key"
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          "
        />
      </div>
      
      <!-- Shop Domain Input (Pre-filled) -->
      <div style="margin-bottom: 20px;">
        <label style="
          display: block;
          font-size: 14px;
          font-weight: 500;
          color: #333;
          margin-bottom: 6px;
        ">Shop Domain:</label>
        <input 
          type="text" 
          id="shop-domain-input" 
          value="{{ shop.permanent_domain }}"
          readonly
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #f8f9fa;
          "
        />
        <small style="color: #666; font-size: 12px;">Your shop domain is automatically detected</small>
      </div>
      
      <!-- Activate Button -->
      <button 
        id="activate-btn"
        onclick="activateLicense()" 
        style="
          background: #28a745;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 6px;
          font-size: 16px;
          cursor: pointer;
          width: 100%;
          font-weight: 500;
        "
      >
        Activate License
      </button>
    </div>
  </div>
</div>

<script>
  // License activation function
  async function activateLicense() {
    const licenseKey = document.getElementById('license-key-input').value.trim();
    const domain = document.getElementById('shop-domain-input').value.trim();
    const activateBtn = document.getElementById('activate-btn');
    const errorMsg = document.getElementById('error-message');
    const successMsg = document.getElementById('success-message');
    
    // Hide previous messages
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';
    
    // Validate inputs
    if (!licenseKey) {
      showError('Please enter your license key');
      return;
    }
    
    if (!domain) {
      showError('Shop domain is required');
      return;
    }
    
    // Show loading state
    activateBtn.disabled = true;
    activateBtn.textContent = 'Activating...';
    
    try {
      const formData = new FormData();
      formData.append('licenseKey', licenseKey);
      formData.append('domain', domain);
      
      const response = await fetch('https://shopift-theme-lisence-app.vercel.app/api/activate', {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccess('License activated successfully! Theme is now unlocked.');
        // Hide the overlay after 2 seconds
        setTimeout(() => {
          document.getElementById('theme-license-notice').style.display = 'none';
        }, 2000);
      } else {
        showError(result.error || 'Activation failed. Please try again.');
      }
      
    } catch (error) {
      console.error('Activation error:', error);
      showError('Network error. Please check your connection and try again.');
    } finally {
      // Reset button state
      activateBtn.disabled = false;
      activateBtn.textContent = 'Activate License';
    }
  }
  
  // Show error message
  function showError(message) {
    const errorMsg = document.getElementById('error-message');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
  }
  
  // Show success message
  function showSuccess(message) {
    const successMsg = document.getElementById('success-message');
    successMsg.textContent = message;
    successMsg.style.display = 'block';
  }
  
  // Check license activation status
  async function checkLicenseStatus() {
    try {
      const response = await fetch('https://shopift-theme-lisence-app.vercel.app/api/license/check?domain={{ shop.permanent_domain }}');
      const data = await response.json();
      
      if (data.success && data.activated) {
        // License is activated, hide the overlay
        const overlay = document.getElementById('theme-license-notice');
        if (overlay) {
          overlay.style.display = 'none';
        }
        return true;
      }
      return false;
    } catch (error) {
      console.error('License check failed:', error);
      return false;
    }
  }

  // Check license status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkLicenseStatus();
  });
  
  // Prevent right-click and common shortcuts when license is not activated
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
  });
  
  document.addEventListener('keydown', function(e) {
    // Disable F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U
    if (e.keyCode === 123 || 
        (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 67)) ||
        (e.ctrlKey && e.keyCode === 85)) {
      e.preventDefault();
    }
  });
  
  // Check license status periodically
  setInterval(function() {
    checkLicenseStatus().then(activated => {
      if (activated) {
        console.log('License activated successfully!');
      }
    });
  }, 30000); // Check every 30 seconds
</script>
{% endunless %}

{% comment %} 
  Additional security: Add this CSS to hide content when JS is disabled
  Add to your theme's main CSS file:
  
  .no-js #theme-license-notice ~ * {
    display: none !important;
  }
{% endcomment %}
